<!DOCTYPE html>
<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,600' rel='stylesheet' type='text/css'>
    <link href='http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>
    <link href='style.css' rel='stylesheet' type='text/css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js'></script>
    <script src='jquery.waypoints.js'></script>
    <script src='scripts.js'></script>
  </head>
  <body>
    <header class='metabar l-metabar'>
      <div class='l-metabar-left l-vertical-center'>
        <img src='logo.png' width='108'>
      </div>
      <div class='l-metabar-center'>
        <span class='section-label js-section-label'>
          <span class='previous'>&nbsp;</span>
          <span class='current'>&nbsp;</span>
          <span class='next'>&nbsp;</span>
        </span>
      </div>
      <div class='l-metabar-right l-vertical-center'>
        <i class='fa fa-search l-mrm'></i>
        <img src='steve.png' width='32'>
      </div>
      <div class='progress-bar js-progress-bar'></div>
    </header>
    <main>
      <div class='l-leftbar js-stick'>
        <ul class='outline'>
          <li>
            <div class='outline__row outline__row--header'>
              <i class='fa fa-chevron-right js-expand'></i>
              <div class='checkbox'></div>
              <a rel='Serverless Puppet'>
                Serverless Puppet
              </a>
            </div>
            <ul>
              <li>
                <div class='outline__row'>
                  <div class='checkbox'></div>
                  <a rel='Resources and the RAL'>
                    Resources and the RAL
                  </a>
                </div>
              </li>
              <li>
                <div class='outline__row'>
                  <div class='checkbox'></div>
                  <a rel='Manifests'>
                    Manifests
                  </a>
                </div>
              </li>
              <li>
                <div class='outline__row'>
                  <div class='checkbox'></div>
                  <a rel='Ordering'>
                    Ordering
                  </a>
                </div>
              </li>
            </ul>
          </li>
          <li>
            <div class='outline__row outline__row--header'>
              <i class='fa fa-chevron-right js-expand'></i>
              <div class='checkbox'></div>
              <a rel='Master/Agent Puppet'>
                Master/Agent Puppet
              </a>
            </div>
            <ul>
              <li>
                <div class='outline__row'>
                  <div class='checkbox'></div>
                  <a rel='Agent Master Basic'>
                    Agent Master Basic
                  </a>
                </div>
              </li>
              <li>
                <div class='outline__row'>
                  <div class='checkbox'></div>
                  <a rel='Agent Prep'>
                    Agent Prep
                  </a>
                </div>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <div class='l-content-wrapper js-waypoint'>
        <div class='module path l-content'>
          <a class='js-page-marker-top' rel=''></a>
          <h1 class='big'>Learning Puppet</h1>
          <a class='js-page-marker-bottom' rel=''></a>
          <div class='module'>
            <a class='js-page-marker-top' rel='Serverless Puppet'></a>
            <h2 class='big'>Serverless Puppet</h2>
            <a class='js-page-marker-bottom' rel='Serverless Puppet'></a>
            <div class='section js-track-progress'>
              <a class='js-page-marker-top' rel='Resources and the RAL'></a>
              <h3 class='big'>Resources and the RAL</h3>
              <p>
                Welcome to Learning Puppet! This series covers the basics of
                writing Puppet code and using Puppet Enterprise. You should
                already have a copy of the Learning Puppet VM; if you don't, you
                can download it for free.
              </p>
              <h4>Begin</h4>
              <p>
                <span class='highlighted'>
                  Log into the Learning Puppet VM as root, and run
                  <span class='code'>puppet resource service</span>
                  .
                </span>
                This command will return something like the following:
              </p>
              <pre>service { 'NetworkManager':&#x000A;    ensure => 'stopped',&#x000A;    enable => 'false',&#x000A;}&#x000A;service { 'acpid':&#x000A;    ensure => 'running',&#x000A;    enable => 'true',&#x000A;}&#x000A;service { 'anacron':&#x000A;    ensure => 'stopped',&#x000A;    enable => 'true',&#x000A;}&#x000A;service { 'apmd':&#x000A;    ensure => 'running',&#x000A;    enable => 'true',&#x000A;}&#x000A;...&#x000A;... (etc.)&#x000A;</pre>
              <p>
                Okay! You've just met your first Puppet resources.
              </p>
              <blockquote>
                <h5>What Just Happened?</h5>
                <ul>
                  <li>
                    <span class='code'>puppet</span>
                    : Most of Puppet's functionality comes from a single
                    <span class='code'>puppet</span>
                    comand, which has many subcommands.
                  </li>
                  <li>
                    <span class='code'>resource</span>
                    : The
                    <span class='code'>resource</span>
                    subcommand can inspect and modify resources interactively.
                  </li>
                  <li>
                    <span class='code'>service</span>
                    : The first argument to the
                    <span class='code'>puppet resource</span>
                    command must be a
                    <strong>resource type,</strong>
                    which you'll learn more about below. A full list of types
                    can be found at
                    <a>the Puppet type reference.</a>
                  </li>
                </ul>
                <p>
                  Taken together, this command inspected every service on the
                  system, whether running or stopped.
                </p>
              </blockquote>
              <h4>Resources</h4>
              <p>
                Imagine a system's configuration as a collection of many
                independent atomic units; call them
                <strong>"resources."</strong>
              </p>
              <p>
                These pieces vary in size, complexity, and lifespan. Any of the
                following (and more) can be modeled as a single resource:
              </p>
              <ul>
                <li>
                  A user account
                </li>
                <li>
                  A specific file
                </li>
                <li>
                  A directory of files
                </li>
                <li>
                  A software package
                </li>
                <li>
                  A running service
                </li>
                <li>
                  A scheduled cron job
                </li>
                <li>
                  An invocation of a shell command, when certain conditions are
                  met
                </li>
              </ul>
              <p>
                Any single resource is very similar to a group of related
                resources:
              </p>
              <ul>
                <li>
                  Every file has a path and an owner
                </li>
                <li>
                  Every user has a name, a UID, and a group
                </li>
              </ul>
              <p>
                The implementation might differ &mdash; for example, you'd need
                a different command to start or stop a service on Windows than
                you would on Linux, and even across Linux distributions there's
                some variety. But conceptually, you're still starting or
                stopping a service, regardless of what you type into the
                console.
              </p>
              <h4>Abstraction</h4>
              <p>
                If you think about resources in this way, there are two notable
                insights you can derive:
              </p>
              <ul>
                <li>
                  <em>
                    Similar resources can be grouped into types.
                  </em>
                  Services will tend to look like services, and users will tend
                  to look like users.
                </li>
                <li>
                  <em>
                    The description of a resource type can be separated from
                    its implementation.
                  </em>
                  You can talk about whether a service is started without
                  needing to know how to start it.
                </li>
              </ul>
              <p>
                To these, Puppet adds a third insight:
              </p>
              <ul>
                <li>
                  With a good enough description of a resource type,
                  <em>
                    it's possible to declare a desired state for a resource
                  </em>
                  &mdash; instead of saying "run this command that starts a
                  service," say "ensure this service is running."
                </li>
              </ul>
              <p>
                These three insights form Puppet's resource abstraction layer
                (RAL). The RAL consists of types (high-level models) and
                providers (platform-specific implementations) &mdash; by
                splitting the two, it lets you describe desired resource states
                in a way that isn't tied to a specific OS.
              </p>
              <h4 id='anatomy-of-a-resource'>Anatomy of a Resource</h4>
              <p>
                In Puppet, every resource is an instance of a
                <strong>resource type</strong>
                and is identified by a
                <strong>title;</strong>
                it has a number of
                <strong>attributes</strong>
                (which are defined by the type), and each attribute has a
                <strong>value.</strong>
              </p>
              <p>Puppet uses its own language to describe and manage resources:</p>
              <pre><code class='ruby'></code></pre>
              <p>
                This syntax is called a
                <strong>resource declaration.</strong>
                You saw it earlier when you ran
                <code>puppet resource service</code>,
              </p>
              <blockquote>
                <p>Try and identify all four parts of the resource declaration above:</p>
                <ul>
                  <li>Type</li>
                  <li>Title</li>
                  <li>Attributes</li>
                  <li>Values</li>
                </ul>
              </blockquote>
              <h4 id='resource-types'>Resource Types</h4>
              <p>
                As mentioned above, every resource has a
                <strong>type.</strong>
              </p>
              <p>
                Puppet has many built-in resource types, and you can install even more as plugins. Each type can behave a bit differently, and has a different set of attributes available.
              </p>
              <p>
                There are several ways to get information about resource types:
              </p>
              <h5 id='the-cheat-sheet'>The Cheat Sheet</h5>
              <p>
                Not all resource types are equally common or useful, so we’ve made a printable cheat sheet that explains the eight most useful types.
                <a href='/puppet_core_types_cheatsheet.pdf'>Download the core types cheat sheet here.</a>
              </p>
              <h5 id='the-type-reference'>The Type Reference</h5>
              <p>
                Experienced Puppet users spend most of their time in
                <a href='../references/latest/type.html'>the type reference</a>.
              </p>
              <p>
                This page lists
                <em>all</em>
                of Puppet’s built-in resource types, in extreme detail. It can be a bit overwhelming for a new user, but it has most of the info you’ll need in a normal day of writing Puppet code.
              </p>
              <p>
                We generate a new type reference for every new version of Puppet, to help ensure that the descriptions stay accurate.
              </p>
              <h5 id='puppet-describe'>Puppet Describe</h5>
              <p>
                The
                <code>puppet describe</code>
                subcommand can list info about the
                <em>currently installed</em>
                resource types on a given machine. This is different from the type reference because it also catches plugins installed by a user, in addition to the built-in types.
              </p>
              <ul>
                <li>
                  <code>puppet describe -l</code>
                  &mdash; List all of the resource types available on the system.
                </li>
                <li>
                  <code>puppet describe -s <TYPE></code>
                  &mdash; Print short information about a type, without describing every attribute
                </li>
                <li>
                  <code>puppet describe <TYPE></code>
                  &mdash; Print long information, similar to what appears in the
                  <a href='../references/latest/type.html'>type reference</a>.
                </li>
              </ul>
              <h4>Browsing and Inspecting Resources</h4>
              <p>
                In the next few chapters, we’ll talk about using the Puppet language to manage resources. For now, though, let’s just look at them for a while.
              </p>
              <h5 id='live-management-in-the-console'>Live Management in the Console</h5>
              <p>
                Puppet Enterprise includes a web console for controlling many of its features. One of the things it can do is browse and inspect resources on any PE systems the console can reach. This supports a limited number of resource types, but has some useful comparison features for correlating data across a large number of nodes.
              </p>
              <blockquote>
                <h5 id='logging-in'>Logging In</h5>
                <p>
                  When you first started your VM, it gave you the URL, username, and password for accessing the console. The user and password should always be
                  <code>puppet@example.com</code>
                  and
                  <code>learningpuppet</code>.
                  <code>https://<IP ADDRESS></code>;
                  <code>facter ipaddress</code>
                  at the command line.
                </p>
              </blockquote>
              <p>
                Once logged in, navigate to “Live Management” in the top menu bar, then click the “Browse Resources” tab. From here, you can
                <a href='/pe/3.0/orchestration_resources.html'>use orchestration to find and inspect resources</a>.
              </p>
              <p>
                Since you’re only using a single node, you won’t see much in the way of comparisons, but you can see the current states of packages, user accounts, etc.
              </p>
              <h5 id='the-puppet-resource-command'>The Puppet Resource Command</h5>
              <p>
                Puppet includes a command called
                <code>puppet resource</code>,
              </p>
              <p>
                Usage of puppet resource is as follows:
              </p>
              <pre># puppet resource <TYPE> [<NAME>] [ATTRIBUTE=VALUE ...]&#x000A;</pre>
              <ul>
                <li>
                  The first argument must be a resource type. If no other arguments are given, it will inspect every resource of that type it can find.
                </li>
                <li>
                  The second argument (optional) is the name of a resource. If no other arguments are given, it will inspect that resource.
                </li>
                <li>
                  After the name, you can optionally specify any number of attributes and values. This will sync those attributes to the desired state, then inspect the final state of the resource.
                </li>
                <li>
                  Alternately, if you specify a resource name and use the
                  <code>--edit</code>
                  flag, you can change that resource in your text editor; after the buffer is saved and closed, Puppet will modify the resource to match your changes.
                </li>
              </ul>
              <blockquote>
                <h5 id='exercises'>Exercises</h5>
                <p>Inspecting a single resource:</p>
                <pre># puppet resource user root&#x000A;&#x000A;user { 'root':&#x000A;  ensure           => 'present',&#x000A;  comment          => 'root',&#x000A;  gid              => '0',&#x000A;  groups           => ['root', 'bin', 'daemon', 'sys', 'adm', 'disk', 'wheel'],&#x000A;  home             => '/root',&#x000A;  password         => '$1$jrm5tnjw$h8JJ9mCZLmJvIxvDLjw1M/',&#x000A;  password_max_age => '99999',&#x000A;  password_min_age => '0',&#x000A;  shell            => '/bin/bash',&#x000A;  uid              => '0',&#x000A;}&#x000A;</pre>
                <p>
                  Setting a new desired state for a resource:
                </p>
                <pre># puppet resource user katie ensure=present shell="/bin/bash" home="/home/katie" managehome=true&#x000A;&#x000A;notice: /User[katie]/ensure: created&#x000A;&#x000A;user { 'katie':&#x000A;  ensure => 'present',&#x000A;  home   => '/home/katie',&#x000A;  shell  => '/bin/bash'&#x000A;}&#x000A;</pre>
              </blockquote>
              <h4 id='next'>Next</h4>
              <p>
                <strong>Next Lesson:</strong>
              </p>
              <p>
                The puppet resource command can be useful for one-off jobs, but Puppet was born for greater things.
                <a href='./manifests.html'>Time to write some manifests</a>.
              </p>
              <p>
                <strong>Off-Road:</strong>
              </p>
              <p>
                The LP VM is a tiny sandbox system, and it doesn’t have much going on. If you have some dev machines that look more like your actual servers, why not
                <a href='http://info.puppetlabs.com/download-pe.html'>download Puppet Enterprise for free</a>
                and inspect them? Follow
                <a href='/pe/latest/quick_start.html'>the quick start guide</a>
                to get a small environment installed, then try using the console to inspect resources for many systems at once.
              </p>
              <a class='js-page-marker-bottom' rel='Resources and the RAL'></a>
              <div class='section-end'>
                <div class='checkbox'></div>
                <span>I finished Resources and the RAL</span>
              </div>
            </div>
            <div class='section js-track-progress'>
              <a class='js-page-marker-top' rel='Manifests'></a>
              <h3 class='big'>Manifests</h3>
              <h2 id='begin'>Begin</h2>
              <p>
                Did you do the
                <code>puppet resource</code>
                exercises from the
                <a href='./ral.html'>last chapter</a>?
              </p>
              <p>
                In a text editor —
                <code>vim</code>,
                <code>emacs</code>,
                <code>nano</code>
                — create a file with the following contents and filename:
              </p>
              <div class='highlight'>
                <pre><code class='ruby'><span class='c1'># /root/examples/user-absent.pp</span>
                <span class='n'>user</span>
                <span class='p'>{</span>
                <span class='s1'>'katie'</span>
                <span class='p'>:</span>
                <span class='k'>ensure</span>
                <span class='o'>=></span>
                <span class='n'>absent</span>
                <span class='p'>,</span>
                <span class='p'>}</span></code></pre>
              </div>
              <p>Save and close the editor, then run:</p>
              <pre><code># puppet apply /root/examples/user-absent.pp&#x000A;notice: /Stage[main]//User[katie]/ensure: removed&#x000A;notice: Finished catalog run in 0.07 seconds</code></pre>
              <p>Now run it again:</p>
              <pre><code># puppet apply /root/examples/user-absent.pp&#x000A;notice: Finished catalog run in 0.03 seconds</code></pre>
              <p>Cool: You’ve just written and applied your first Puppet manifest.</p>
              <h2 id='manifests'>Manifests</h2>
              <p>
                Puppet programs are called “manifests,” and they use the
                <code>.pp</code>
                file extension.
              </p>
              <p>
                The core of the Puppet language is the
                <em>resource declaration.</em>
                A resource declaration describes a
                <em>desired state</em>
                for one resource.
              </p>
              <p>(Manifests can also use various kinds of logic: conditional statements, collections of resources, functions to generate text, etc. We’ll get to these later.)</p>
              <h2 id='puppet-apply'>Puppet Apply</h2>
              <p>
                Like
                <code>resource</code>
                in the last chapter,
                <code>apply</code>
                is a Puppet subcommand. It takes the name of a manifest file as its argument, and enforces the desired state described in the manifest.
              </p>
              <p>We’ll use it below to test small manifests, but it can be used for larger jobs too. In fact, it can do nearly everything an agent/master Puppet environment can do.</p>
              <h2 id='resource-declarations'>Resource Declarations</h2>
              <p>Let’s start by looking at a single resource:</p>
              <div class='highlight'>
                <pre><code class='ruby'><span class='c1'># /root/examples/file-1.pp</span>
                <span class='n'>file</span>
                <span class='p'>{</span>
                <span class='s1'>'testfile'</span>
                <span class='p'>:</span>
                <span class='n'>path</span>
                <span class='o'>=></span>
                <span class='s1'>'/tmp/testfile'</span>
                <span class='p'>,</span>
                <span class='k'>ensure</span>
                <span class='o'>=></span>
                <span class='n'>present</span>
                <span class='p'>,</span>
                <span class='n'>mode</span>
                <span class='o'>=></span>
                <span class='mo'>0640</span>
                <span class='p'>,</span>
                <span class='n'>content</span>
                <span class='o'>=></span>
                <span class='s2'>"I'm a test file."</span>
                <span class='p'>,</span>
                <span class='p'>}</span></code></pre>
              </div>
              <p><a href='/puppet/latest/reference/lang_resources.html'>The complete syntax and behavior of resource declarations are documented in the Puppet reference manual</a>, but in short, they consist of:
              </p>
              <ul>
                <li>
                  The
                  <strong>type</strong>
                  (<code>file</code>, in this case)
                </li>
                <li>
                  An opening curly brace (<code>{</code>)
                  <ul>
                    <li>
                      The
                      <strong>title</strong>
                      (<code>testfile</code>)
                    </li>
                    <li>
                      A colon (<code>:</code>)
                    </li>
                    <li>
                      A set of
                      <strong>
                        attribute
                        <code>=></code>
                        value
                      </strong>
                      pairs, with a comma after each pair (
                      <code>path => '/tmp/testfile',</code>
                      etc.)
                    </li>
                  </ul>
                </li>
                <li>
                  A closing curly brace (<code>}</code>)
                </li>
              </ul>
              <p>Try applying the short manifest above:</p>
              <pre><code># puppet apply /root/examples/file-1.pp&#x000A;notice: /Stage[main]//File[testfile]/ensure: created&#x000A;notice: Finished catalog run in 0.05 seconds</code></pre>
              <p>This is just the reverse of what we saw above when we removed the user account: Puppet noticed that the file didn’t exist, and created it. It set the desired content and mode at the same time.</p>
              <pre><code># cat /tmp/testfile&#x000A;I'm a test file.&#x000A;# ls -lah /tmp/testfile&#x000A;-rw-r----- 1 root root 16 Feb 23 13:15 /tmp/testfile</code></pre>
              <p>If we try changing the mode and applying the manifest again, Puppet will fix it:</p>
              <pre><code># chmod 0666 /tmp/testfile&#x000A;# puppet apply /root/examples/file-1.pp&#x000A;notice: /Stage[main]//File[testfile]/mode: mode changed '0666' to '0640'&#x000A;notice: Finished catalog run in 0.04 seconds</code></pre>
              <p>And if you run the manifest again, you’ll see that Puppet doesn’t do anything — if a resource is in the desired state already, Puppet will leave it alone.</p>
              <blockquote>
                <p>
                  <strong>Exercise:</strong>
                  Declare another file resource in a manifest and apply it. Try setting a new desired state for an existing file — for example, changing the login message by setting the content of
                  <code>/etc/motd</code>.
                  <a href='/references/latest/type.html#file'>see the attributes available for the file type here.</a>
                </p>
              </blockquote>
              <h3 id='syntax-hints'>Syntax Hints</h3>
              <p>Watch out for these common errors:</p>
              <ul>
                <li>
                  Don’t forget commas and colons! Forgetting them causes errors like
                  <code>Could not parse for environment production: Syntax error at 'mode'; expected '}' at /root/manifests/1.file.pp:6 on node learn.localdomain</code>.
                </li>
                <li>Capitalization matters! The resource type and the attribute names should always be lowercase.</li>
                <li>
                  The values used for titles and attribute values will usually be
                  <a href='/puppet/latest/reference/lang_datatypes.html#strings'>strings</a>,
                  <a href='/puppet/latest/reference/lang_datatypes.html'>Read more about Puppet’s data types here.</a>
                  <ul>
                    <li>
                      There are two kinds of quotes in Puppet: single (<code>'</code>) and double (<code>"</code>). The main difference is that double quotes let you interpolate $variables, which we cover in another lesson.
                    </li>
                    <li>
                      Attribute names (like
                      <code>path</code>,
                      <code>ensure</code>,
                    </li>
                  </ul>
                </li>
              </ul>
              <p>
                Also, note that Puppet lets you use whatever whitespace makes your manifests more readable. We suggest visually lining up the
                <code>=></code>
                arrows, because it makes it easier to understand a manifest at a glance. (The Vim plugins on the Learning Puppet VM will do this automatically as you type.)
              </p>
              <h2 id='once-more-with-feeling'>Once More, With Feeling!</h2>
              <p>Now that you know resource declarations, let’s play with the file type some more. We’ll:</p>
              <ul>
                <li>Put multiple resources of different types in the same manifest</li>
                <li>
                  Use new values for the
                  <code>ensure</code>
                  attribute
                </li>
                <li>Find an attribute with a special relationship to the resource title</li>
                <li>See what happens when we leave off certain attributes</li>
                <li>See some automatic permission adjustments on directories</li>
              </ul>
              <div class='highlight'>
                <pre><code class='ruby'><span class='c1'># /root/examples/file-2.pp</span>
                <span class='n'>file</span>
                <span class='p'>{</span>
                <span class='s1'>'/tmp/test1'</span>
                <span class='p'>:</span>
                <span class='k'>ensure</span>
                <span class='o'>=></span>
                <span class='n'>file</span>
                <span class='p'>,</span>
                <span class='n'>content</span>
                <span class='o'>=></span>
                <span class='s2'>"Hi.</span>
                <span class='se'>\n</span>
                <span class='s2'>"</span>
                <span class='p'>,</span>
                <span class='p'>}</span>
                <span class='n'>file</span>
                <span class='p'>{</span>
                <span class='s1'>'/tmp/test2'</span>
                <span class='p'>:</span>
                <span class='k'>ensure</span>
                <span class='o'>=></span>
                <span class='n'>directory</span>
                <span class='p'>,</span>
                <span class='n'>mode</span>
                <span class='o'>=></span>
                <span class='mo'>0644</span>
                <span class='p'>,</span>
                <span class='p'>}</span>
                <span class='n'>file</span>
                <span class='p'>{</span>
                <span class='s1'>'/tmp/test3'</span>
                <span class='p'>:</span>
                <span class='k'>ensure</span>
                <span class='o'>=></span>
                <span class='n'>link</span>
                <span class='p'>,</span>
                <span class='n'>target</span>
                <span class='o'>=></span>
                <span class='s1'>'/tmp/test1'</span>
                <span class='p'>,</span>
                <span class='p'>}</span>
                <span class='n'>user</span>
                <span class='p'>{</span>
                <span class='s1'>'katie'</span>
                <span class='p'>:</span>
                <span class='k'>ensure</span>
                <span class='o'>=></span>
                <span class='n'>absent</span>
                <span class='p'>,</span>
                <span class='p'>}</span>
                <span class='n'>notify</span>
                <span class='p'>{</span>
                <span class='s2'>"I'm notifying you."</span>
                <span class='p'>:}</span>
                <span class='n'>notify</span>
                <span class='p'>{</span>
                <span class='s2'>"So am I!"</span>
                <span class='p'>:}</span></code></pre>
              </div>
              <p>Apply:</p>
              <pre><code># puppet apply /root/examples/file-2.pp&#x000A;notice: /Stage[main]//File[/tmp/test1]/ensure: created&#x000A;notice: /Stage[main]//File[/tmp/test3]/ensure: created&#x000A;notice: /Stage[main]//File[/tmp/test2]/ensure: created&#x000A;notice: So am I!&#x000A;notice: /Stage[main]//Notify[So am I!]/message: defined 'message' as 'So am I!'&#x000A;notice: I'm notifying you.&#x000A;notice: /Stage[main]//Notify[I'm notifying you.]/message: defined 'message' as 'I'm notifying you.'&#x000A;notice: Finished catalog run in 0.05 seconds</code></pre>
              <p>Cool. What just happened?</p>
              <h3 id='new-ensure-values-different-states'>New Ensure Values, Different States</h3>
              <p>
                The
                <code>ensure</code>
                attribute is somewhat special. It’s available on most (but not all) resource types, and it controls whether the resource exists, with the definition of “exists” being somewhat local.
              </p>
              <p>With files, there are several ways to exist:</p>
              <ul>
                <li>
                  As a normal file (<code>ensure => file</code>)
                </li>
                <li>
                  As a directory (<code>ensure => directory</code>)
                </li>
                <li>
                  As a symlink (<code>ensure => link</code>)
                </li>
                <li>
                  As any of the above (<code>ensure => present</code>)
                </li>
                <li>
                  As nothing (<code>ensure => absent</code>).
                </li>
              </ul>
              <p>A quick check shows how our manifest played out:</p>
              <pre><code># ls -lah /tmp/test*&#x000A;-rw-r--r--  1 root root    3 Feb 23 15:54 test1&#x000A;lrwxrwxrwx  1 root root   10 Feb 23 15:54 test3 -> /tmp/test1&#x000A;&#x000A;/tmp/test2:&#x000A;total 16K&#x000A;drwxr-xr-x 2 root root 4.0K Feb 23 16:02 .&#x000A;drwxrwxrwt 5 root root 4.0K Feb 23 16:02 ..&#x000A;&#x000A;# cat /tmp/test3&#x000A;Hi.</code></pre>
              <h3 id='titles-and-namevars'>Titles and Namevars</h3>
              <p>
                Notice how our original file resource had a
                <code>path</code>
                attribute, but our next three left it out?
              </p>
              <p>
                Almost every resource type has one attribute whose value defaults to the resource’s title. For the
                <code>file</code>
                resource, that’s
                <code>path</code>.
                <code>user</code>,
                <code>group</code>,
                <code>package</code>…),
                <code>name</code>.
              </p>
              <p>
                These attributes are called
                <strong>“namevars.”</strong>
                They are generally the attribute that corresponds to the resource’s
                <em>identity,</em>
                the one thing that should always be unique.
              </p>
              <p>
                If you leave out the namevar for a resource, Puppet will re-use the title as its value. If you
                <em>do</em>
                specify a value for the namevar, the title of the resource can be anything.
              </p>
              <blockquote>
                <h4 id='identity-and-identity'>Identity and Identity</h4>
                <p>So why even have a namevar, if Puppet can just re-use the title?</p>
                <p>There are two kinds of identity that Puppet recognizes:</p>
                <ul>
                  <li>Identity within Puppet itself</li>
                  <li>Identity on the target system</li>
                </ul>
                <p>
                  Most of the time these are the same, but sometimes they aren’t. For example, the NTP service has a different name on different platforms: on Red Hat-like systems, it’s called
                  <code>ntpd</code>,
                  <code>ntp</code>.
                </p>
                <p>Also, there are cases (usually exec resources) where the system identity has no particular meaning, and putting a more descriptive identity in the title can help tell your colleagues (or yourself in two months) what a resource is supposed to be doing.</p>
                <p>By allowing you to split the title and namevar, Puppet makes it easy to handle these cases. We’ll cover this later when we get to conditional statements.</p>
                <h4 id='uniqueness'>Uniqueness</h4>
                <p>
                  Note that you can’t declare the same resource twice: Puppet always disallows duplicate
                  <em>titles</em>
                  within a given type, and usually disallows duplicate
                  <em>namevar values</em>
                  within a type.
                </p>
                <p>This is because resource declarations represent desired final states, and it’s not at all clear what should happen if you declare two conflicting states. So Puppet will fail with an error instead of accidentally doing something wrong to the system.</p>
              </blockquote>
              <h3 id='missing-attributes-desired-state--whatever'>Missing Attributes: “Desired State = Whatever”</h3>
              <p>
                On the
                <code>/tmp/test1</code>
                file, we left off the
                <code>mode</code>
                and
                <code>owner</code>
                attributes, among others. When we omit attributes, Puppet doesn’t manage them, and any value is assumed to be the desired state.
              </p>
              <p>If a file doesn’t exist, Puppet will default to creating it with permissions mode 0644, but if you change that mode, Puppet won’t change it back.</p>
              <p>
                Note that you can even leave off the
                <code>ensure</code>
                attribute, as long as you don’t specify
                <code>content</code>
                or
                <code>source</code>
                — this can let you manage the permissions of a file if it exists, but not create it if it doesn’t.
              </p>
              <h3 id='directory-permissions-644--755'>Directory Permissions: 644 = 755</h3>
              <p>
                We said
                <code>/tmp/test2/</code>
                should have permissions mode 0644, but our
                <code>ls -lah</code>
                showed mode 0755. That’s because Puppet groups the read and traverse permissions for directories.
              </p>
              <blockquote>
                <p>
                  <strong>Details:</strong>
                  With directories, the 4 bit controls whether someone can
                  <em>list</em>
                  the directory and the 1 bit controls whether they can
                  <em>access any files</em>
                  it contains.
                </p>
                <p>
                  Most of the time, you want these abilities to be grouped together. However, when recursively managing directories with the
                  <code>recurse</code>
                  attribute, you wouldn’t want to set all permissions to 0755, because any plain files contained by the directory would become executable! And if Puppet didn’t automatically adjust directory permissions, recursively setting permissions of 0644 would make the files in a directory inaccessible to users who should be able to access them.
                </p>
                <p>By automatically grouping those permissions, it becomes much easier to set a directory’s permissions to match the permissions of the files it contains.</p>
              </blockquote>
              <h2 id='destinations-not-journeys'>Destinations, Not Journeys</h2>
              <p>You’ve noticed that we talk about “desired states” a lot, instead of talking about making changes to the system. This is the core of thinking like a Puppet user.</p>
              <p>
                If you were writing an explanation to another human of how to put a system into a desired state, using the OS’s default tools, it would read something like “Check whether the mode of the sudoers file is 0440, using
                <code>ls -l</code>.
                <code>chmod 0440 /etc/sudoers</code>.”
              </p>
              <p>Under the hood, Puppet is actually doing the same thing, with some of the same OS tools. But it wraps the “check” step together with the “and fix if needed” step, and presents them as a single interface.</p>
              <p>The effect is that, instead of writing a bash script that looks like a step-by-step for a beginning user, you can write Puppet manifests that look like shorthand notes for an expert user.</p>
              <blockquote>
                <h2 id='aside-compilation'>Aside: Compilation</h2>
                <p>Manifests don’t get used directly when Puppet syncs resources. Instead, the flow of a Puppet run goes a little like this:</p>
                <p>
                  <img alt='Diagram: Manifests are compiled into a catalog, which is then applied to yield the desired system state.' src='./images/manifest_to_defined_state_unified.png'>
                </p>
                <p>
                  As we mentioned above, manifests can contain conditional statements, variables, functions, and other forms of logic. But before being applied, manifests get
                  <em>compiled</em>
                  into a document called a
                  <strong>“catalog,”</strong>
                  which
                  <em>only</em>
                  contains resources and hints about the order to sync them in.
                </p>
                <p>With puppet apply, the distinction doesn’t mean much. In a master/agent Puppet environment, though, it matters more, because agents only see the catalog:</p>
                <ul>
                  <li>
                    By using logic, manifests can be flexible and describe many systems at once. A catalog describes desired states for
                    <strong>one</strong>
                    system.
                  </li>
                  <li>By default, agent nodes can only retrieve their own catalog; they can’t see information meant for any other node. This separation improves security.</li>
                  <li>
                    Since catalogs are so unambiguous, it’s possible to
                    <em>simulate</em>
                    a catalog run without making any changes to the system. (This is usually done by running
                    <code>puppet agent --test --noop</code>.)
                  </li>
                </ul>
              </blockquote>
              <h2 id='the-site-manifest-and-puppet-agent'>The Site Manifest and Puppet Agent</h2>
              <p>We’ve seen how to use puppet apply to directly apply manifests on one system. The puppet master/agent services work very similarly, but with a few key differences:</p>
              <p>
                <strong>Puppet apply:</strong>
              </p>
              <ul>
                <li>A user executes a command, triggering a Puppet run.</li>
                <li>Puppet apply reads the manifest passed to it, compiles it into a catalog, and applies the catalog.</li>
              </ul>
              <p>
                <strong>Puppet agent/master:</strong>
              </p>
              <ul>
                <li>
                  Puppet agent runs as a service, and triggers a Puppet run about every half hour (configurable).
                  <ul>
                    <li>
                      On your VM, which runs Puppet Enterprise, the agent service is named
                      <code>pe-puppet</code>.
                    </li>
                  </ul>
                </li>
                <li>
                  Puppet agent does not have access to any manifests; instead, it requests a pre-compiled catalog from a puppet master server.
                  <ul>
                    <li>
                      On your VM, the puppet master appears as the
                      <code>pe-httpd</code>
                      service. A sandboxed copy of Apache with Passenger manages the puppet master application, spawning and killing new copies of it as needed.
                    </li>
                  </ul>
                </li>
                <li>
                  The puppet master always reads
                  <strong>one</strong>
                  special manifest, called the “site manifest” or site.pp. It uses this to compile a catalog, which it sends back to the agent.
                  <ul>
                    <li>
                      On your VM, the site manifest is at
                      <code>/etc/puppetlabs/puppet/manifests/site.pp</code>.
                    </li>
                  </ul>
                </li>
                <li>After getting the catalog, the agent applies it.</li>
              </ul>
              <p>This way, you can have many machines being configured by Puppet, while only maintaining your manifests on one (or a few) servers. This also gives some extra security, as described above under “Compilation.”</p>
              <blockquote>
                <h3 id='exercise-use-puppet-agentmaster-to-apply-the-same-configuration'>Exercise: Use Puppet Agent/Master to Apply the Same Configuration</h3>
                <p>To see how the same manifest code works in puppet agent:</p>
                <ul>
                  <li>
                    Edit
                    <code>/etc/puppetlabs/puppet/manifests/site.pp</code>
                    and paste in the three file resources from the manifest above.
                    <ul>
                      <li>
                        Watch out for some of the existing code in site.pp, and don’t disturb any
                        <code>node</code>
                        statements yet. You can paste the resources at the bottom of the file and they’ll work fine.
                      </li>
                    </ul>
                  </li>
                  <li>
                    Delete or mutilate the files and directories we created in
                    <code>/tmp</code>.
                  </li>
                  <li>
                    Run
                    <code>puppet agent --test</code>,
                  </li>
                  <li>
                    Check
                    <code>/tmp</code>,
                  </li>
                </ul>
              </blockquote>
              <blockquote>
                <h3 id='exercise-ssh-authorized-key'>Exercise: SSH Authorized Key</h3>
                <p>
                  Write and apply a manifest that uses the
                  <a href='/references/stable/type.html#sshauthorizedkey'>
                    <code>ssh_authorized_key</code>
                    type
                  </a>
                  to let you log into the learning VM as root without a password.
                </p>
                <p>
                  <strong>Bonus work:</strong>
                  Try putting it directly into the site manifest, instead of using puppet apply.
                  <a href='/pe/latest/orchestration_puppet.html'>Use the console to trigger a puppet agent run</a>,
                  <a href='/pe/latest/console_reports.html'>check the reports in the console</a>
                  to see whether the manifest worked.
                </p>
                <ul>
                  <li>You’ll need to have an SSH key pair, a terminal application on your host system, and some basic understanding of how SSH works. You can get all of these with a little outside research.</li>
                  <li>
                    Watch out: you can’t just paste the line from
                    <code>id_rsa.pub</code>
                    into the
                    <code>key</code>
                    attribute of the resource. You’ll need to separate its components out into multiple attributes. Read the documentation for the
                    <code>ssh_authorized_key</code>
                    type to see how.
                  </li>
                </ul>
              </blockquote>
              <h2 id='next'>Next</h2>
              <p>
                <strong>Next Lesson:</strong>
              </p>
              <p>
                You know how to use the fundamental building blocks of Puppet code, so now it’s time to learn
                <a href='./ordering.html'>how those blocks fit together</a>.
              </p>
              <p>
                <strong>Off-Road:</strong>
              </p>
              <p>You already know how to do a bit with Puppet, and managing file ownership and permissions is important.</p>
              <p>
                Are there any files on your systems that you’ve had a hard time keeping in sync? You already know enough to lock them down.
                <a href='http://info.puppetlabs.com/download-pe.html'>Download Puppet Enterprise for free</a>,
                <a href='/pe/latest/quick_start.html'>the quick start guide</a>
                to get a small environment installed, then try putting some file resources at the bottom of the puppet master’s
                <code>site.pp</code>
                file to manage those files on every machine.
              </p>
              <a class='js-page-marker-bottom' rel='Manifests'></a>
            </div>
          </div>
        </div>
        <div class='spacer'></div>
      </div>
      <div class='l-rightbar'>
        Notes section
      </div>
    </main>
  </body>
</html>
